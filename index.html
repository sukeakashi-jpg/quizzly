<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Quizly — Pregunta del Día</title>

<!-- Fuentes: Newsreader (serif elegante) + Poppins fallback -->
<link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,300;0,400;0,600;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  :root{
    /* Palette: beige primary, navy accents */
    --beige:#f6efe6;     /* main background */
    --beige-2:#efe7d9;   /* surfaces */
    --navy:#0b1c33;      /* accent / text */
    --navy-2:#162a44;
    --muted:#7c7c7c;
    --accent:#2f6fae;     /* secondary accent */
    --success:#2f8f58;
    --danger:#b54b4b;
    --card-shadow: 0 18px 40px rgba(11,28,51,0.08);
    --anim:.9s;
    --radius:14px;
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background:var(--beige);
    font-family:"Newsreader", "Poppins", serif;
    color:var(--navy);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.35;
    padding:18px;
    display:flex;
    justify-content:center;
    align-items:flex-start;
  }

  /* App wrapper */
  .wrap{
    width:100%;
    max-width:420px;
    margin:12px auto;
  }

  /* Topbar: logo + language toggle */
  .topbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:14px;
  }
  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:56px;height:56px;border-radius:12px;
    background:linear-gradient(180deg,var(--beige-2),#f0e6d8);
    display:flex;align-items:center;justify-content:center;
    box-shadow:var(--card-shadow);
    border:1px solid rgba(11,28,51,0.06);
    font-weight:700;color:var(--navy);font-size:18px;
  }
  .brand h1{font-size:18px;margin:0;font-weight:600}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  /* Language toggle */
  .lang-toggle{
    display:flex;
    gap:6px;
    align-items:center;
    background:transparent;border-radius:12px;padding:6px;
  }
  .lang-btn{
    border:2px solid rgba(11,28,51,0.06);
    background:transparent;padding:6px 10px;border-radius:8px;
    cursor:pointer;font-weight:700;color:var(--navy);
  }
  .lang-btn.active{background:var(--navy);color:var(--beige);border-color:var(--navy)}
  .lang-btn:focus{outline:3px solid rgba(47,111,174,0.18)}

  /* App card */
  .app{
    background:var(--beige-2);
    border-radius:var(--radius);
    padding:14px;
    box-shadow:var(--card-shadow);
    border:1px solid rgba(11,28,51,0.04);
  }

  header{display:flex;justify-content:space-between;align-items:center}
  h2.title{font-size:20px;margin:0;color:var(--navy)}
  p.lead{font-size:12px;color:var(--muted);margin-top:6px}

  main{margin-top:12px}

  /* Screens */
  .screen{display:none;opacity:0;transform:translateY(8px) scale(.995);transition:opacity var(--anim) ease,transform var(--anim) ease}
  .screen.active{display:block;opacity:1;transform:none}

  /* Splash */
  #splash{
    position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;
    background:var(--beige);z-index:9999;flex-direction:column;gap:18px;
  }
  #splash .splash-box{
    width:320px;max-width:90%;padding:18px;border-radius:14px;background:linear-gradient(180deg,var(--beige-2),#fff);
    box-shadow:var(--card-shadow);border:1px solid rgba(11,28,51,0.04);text-align:center;
  }
  #splash .logo-lg{width:84px;height:84px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;background:var(--navy);color:var(--beige);font-weight:800;font-size:28px}
  #splash .phrase{font-size:14px;color:var(--navy);margin-top:12px;font-style:italic}

  /* Forms & buttons */
  .center{display:flex;flex-direction:column;gap:10px;align-items:stretch}
  input[type="text"]{
    padding:10px;border-radius:10px;border:1px solid rgba(11,28,51,0.06);background:#fff;font-size:14px;color:var(--navy)
  }

  .row{display:flex;gap:8px}
  .btn{
    padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;
    background:var(--navy);color:var(--beige);
    box-shadow:0 8px 20px rgba(11,28,51,0.08);
    transition:transform .18s ease,opacity .18s ease;
  }
  .btn:hover{transform:translateY(-3px)}
  .btn.ghost{background:transparent;color:var(--navy);border:2px solid rgba(11,28,51,0.06);box-shadow:none}
  .btn.ghost:hover{border-color:var(--accent)}

  /* Topics grid */
  .topics{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
  .topic{
    background:var(--beige);
    border-radius:10px;padding:10px;border:1px solid rgba(11,28,51,0.04);
    font-weight:700;color:var(--navy);text-align:center;cursor:pointer;
    transition:transform .18s ease,box-shadow .18s ease;
  }
  .topic:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(11,28,51,0.04)}
  .topic.selected{box-shadow:0 10px 26px rgba(47,111,174,0.14);border-color:var(--accent)}

  /* Card (quiz) */
  .card{background:#fff;padding:12px;border-radius:12px;border:1px solid rgba(11,28,51,0.04)}
  .question{font-size:17px;font-weight:700;color:var(--navy);margin-bottom:6px}
  .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
  .options{display:flex;flex-direction:column;gap:8px}
  .option{
    padding:10px;border-radius:10px;border:1px solid rgba(11,28,51,0.06);background:var(--beige);
    cursor:pointer;font-weight:700;color:var(--navy);transition:transform .18s ease,box-shadow .18s ease;
  }
  .option:hover{transform:translateY(-3px);box-shadow:0 12px 26px rgba(11,28,51,0.04)}
  .option.disabled{opacity:0.55;pointer-events:none}
  .option.correct{background:linear-gradient(90deg,#e9f7ee,#e2f3e5);border-color:rgba(47,143,88,0.12)}
  .option.wrong{background:linear-gradient(90deg,#fff1f0,#ffe6e6);border-color:rgba(181,75,75,0.12)}

  .status{font-size:13px;color:var(--muted);margin-top:8px}

  /* History list */
  .history{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .hist-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:10px;background:#fff;border:1px solid rgba(11,28,51,0.04);font-size:13px;color:var(--navy)}

  footer{margin-top:12px;text-align:center;font-size:12px;color:var(--muted)}

  @media (max-width:420px){
    body{padding:10px}
    .logo{width:48px;height:48px;font-size:16px}
    .brand h1{font-size:16px}
    .splash-box{width:92%}
  }
</style>
</head>
<body>

<!-- SPLASH with stoic phrases -->
<div id="splash" role="status" aria-live="polite">
  <div class="splash-box" role="img" aria-label="Quizly splash">
    <div class="logo-lg" aria-hidden="true">QZ</div>
    <div style="margin-top:12px;font-weight:700;color:var(--navy)">Quizly</div>
    <div id="splashPhrase" class="phrase">Focus only on what you can control.</div>
    <div style="height:10px"></div>
    <div style="font-size:12px;color:var(--muted)">Loading...</div>
  </div>
</div>

<div class="wrap" role="application" aria-labelledby="appTitle">
  <div class="topbar" aria-hidden="false">
    <div class="brand" style="gap:12px">
      <div class="logo" aria-hidden="true">QZ</div>
      <div>
        <h1 class="title" id="appTitle">Quizly</h1>
        <p class="lead" id="leadText">Pregunta del día</p>
      </div>
    </div>

    <div class="lang-toggle" aria-label="Language toggle">
      <button id="btnEN" class="lang-btn active" aria-pressed="true">EN</button>
      <button id="btnES" class="lang-btn" aria-pressed="false">ES</button>
    </div>
  </div>

  <div class="app" id="appCard">
    <main>
      <!-- LOGIN -->
      <section id="screen-login" class="screen active" aria-hidden="false">
        <div class="center">
          <h2 style="margin:0;font-size:18px;color:var(--navy)" id="welcomeTitle">Welcome</h2>
          <p class="meta" id="welcomeMeta">Enter your name to start and save progress on this device.</p>
          <input id="inputName" type="text" placeholder="Your name (e.g. Judson)" aria-label="User name">
          <div class="row" style="margin-top:6px">
            <button id="btnStart" class="btn" style="flex:1">Start</button>
            <button id="btnGuest" class="btn ghost" style="flex:1">Guest</button>
          </div>
        </div>
      </section>

      <!-- TOPIC SELECT -->
      <section id="screen-topics" class="screen" aria-hidden="true">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0;font-size:16px;color:var(--navy)" id="chooseTitle">Choose a topic</h3>
            <p class="meta" id="chooseMeta">Select the category for today's question</p>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="userShort" style="font-weight:700;color:var(--navy)"></div>
            <button id="btnLogout" class="btn ghost" aria-label="Logout">Logout</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <div id="topics" class="topics" aria-label="Topics"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnOpenQuiz" class="btn" style="flex:1">View question</button>
          <button id="btnHistory" class="btn ghost" style="flex:1">History</button>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="screen-quiz" class="screen" aria-hidden="true">
        <div class="card" role="region" aria-labelledby="questionText">
          <div style="display:flex;justify-content:space-between;align-items:flex-start">
            <div style="flex:1">
              <div id="questionText" class="question">—</div>
              <div id="metaInfo" class="meta">Topic • Question of the day</div>
            </div>
            <div style="min-width:90px;text-align:right">
              <button id="btnChangeTopic" class="btn ghost" style="min-width:75px">Change</button>
            </div>
          </div>

          <div style="height:10px"></div>
          <div id="options" class="options" role="list"></div>
          <div id="statusText" class="status" aria-live="polite"></div>
        </div>
      </section>

      <!-- RESULT -->
      <section id="screen-result" class="screen" aria-hidden="true">
        <div style="text-align:center;padding:10px">
          <div id="resultTitle" class="question" style="font-size:18px">—</div>
          <div id="resultMsg" class="meta">—</div>
          <div style="height:10px"></div>
          <button id="btnBackHome" class="btn">Back</button>
          <div style="height:8px"></div>
          <button id="btnLogout2" class="btn ghost">Logout</button>
        </div>
      </section>

      <!-- HISTORY -->
      <section id="screen-history" class="screen" aria-hidden="true">
        <div>
          <h3 style="margin:0;font-size:16px;color:var(--navy)" id="historyTitle">History</h3>
          <p class="meta" id="historyMeta">Your previous answers</p>
        </div>

        <div style="height:8px"></div>
        <div id="historyList" class="history" aria-live="polite"></div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnBackToTopics" class="btn ghost" style="flex:1">Back</button>
          <button id="btnClearHistory" class="btn" style="flex:1">Clear history</button>
        </div>
      </section>
    </main>

    <footer id="footerText">Colegio Agropecuario de San Carlos — Diseño de Software — 2025</footer>
  </div>
</div>

<script>
/* =========================
   Data & Translations
   ========================= */
const STOIC_PHRASES_EN = [
  "Focus only on what you can control.",
  "Waste no more time arguing what a good person should be.",
  "The impediment to action advances action.",
  "We suffer more often in imagination than in reality.",
  "He who fears death will never do anything worth of a man."
];

const BANK = {
  'Science': [
    { q:'What is the basic unit of life?', opts:['Atom','Cell','Molecule','Organ'], a:1 },
    { q:'Which gas do we mainly breathe?', opts:['Nitrogen','Oxygen','Hydrogen','Carbon dioxide'], a:1 }
  ],
  'History': [
    { q:'In which year did Columbus reach America?', opts:['1492','1502','1592','1392'], a:0 },
    { q:'Who was the first President of the United States?', opts:['Thomas Jefferson','George Washington','Abraham Lincoln','John Adams'], a:1 }
  ],
  'Mathematics': [
    { q:'What is 12 × 8?', opts:['96','86','104','88'], a:0 },
    { q:'Approximate value of π?', opts:['2.14','3.14','3.41','4.13'], a:1 }
  ],
  'General Culture': [
    { q:'What is the capital of Costa Rica?', opts:['San José','Alajuela','Heredia','Cartago'], a:0 },
    { q:'Who wrote "One Hundred Years of Solitude"?', opts:['García Márquez','Pablo Neruda','Vargas Llosa','Isabel Allende'], a:0 }
  ]
};

/* Translations object: EN and ES */
const I18N = {
  en: {
    welcome: "Welcome",
    welcomeMeta: "Enter your name to start and save progress on this device.",
    start: "Start",
    guest: "Guest",
    chooseTopic: "Choose a topic",
    chooseMeta: "Select the category for today's question",
    viewQuestion: "View question",
    history: "History",
    logout: "Logout",
    change: "Change",
    back: "Back",
    clearHistory: "Clear history",
    alreadyAnsweredTitle: "You've already answered today.",
    alreadyAnsweredMsg: "Come back tomorrow for the next question.",
    correctTitle: "Correct!",
    wrongTitle: "Not this time",
    correctMsg: "You answered today's question correctly.",
    wrongMsg: "Your answer was recorded. Try again tomorrow.",
    loading: "Loading...",
    historyEmpty: "No records yet.",
    deleteConfirm: "Clear history for this user?",
    logoutConfirm: "Are you sure you want to logout?"
  },
  es: {
    welcome: "Bienvenido",
    welcomeMeta: "Ingresa tu nombre para comenzar y guardar el progreso en este dispositivo.",
    start: "Comenzar",
    guest: "Invitado",
    chooseTopic: "Elige un tema",
    chooseMeta: "Selecciona la categoría para la pregunta de hoy",
    viewQuestion: "Ver pregunta",
    history: "Historial",
    logout: "Cerrar sesión",
    change: "Cambiar",
    back: "Volver",
    clearHistory: "Borrar historial",
    alreadyAnsweredTitle: "Ya respondiste hoy.",
    alreadyAnsweredMsg: "Vuelve mañana para la siguiente pregunta.",
    correctTitle: "¡Correcto!",
    wrongTitle: "No fue esta vez",
    correctMsg: "Has respondido correctamente la pregunta de hoy.",
    wrongMsg: "La respuesta fue registrada. Intenta mañana.",
    loading: "Cargando...",
    historyEmpty: "Sin registros aún.",
    deleteConfirm: "¿Borrar historial de este usuario?",
    logoutConfirm: "¿Cerrar sesión?"
  }
};

/* =========================
   State & Storage helpers
   ========================= */
const $ = id => document.getElementById(id);
const todayKey = () => { const d = new Date(); return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; };

function loadState(){ try { return JSON.parse(localStorage.getItem('quizly_app')||'{}'); } catch(e){ return {}; } }
function saveState(s){ localStorage.setItem('quizly_app', JSON.stringify(s)); }

let state = loadState();
if(!state.users) state.users = {}; // username -> {history:[], lastAnswered:''}
if(!state.current) state.current = { name:null, topic:null, lang:'en' };

/* UI refs */
const screens = document.querySelectorAll('.screen');
const screenLogin = $('screen-login'), screenTopics = $('screen-topics'), screenQuiz = $('screen-quiz'),
      screenResult = $('screen-result'), screenHistory = $('screen-history');
const inputName = $('inputName'), userShort = $('userShort');
const topicsDiv = $('topics'), btnOpenQuiz = $('btnOpenQuiz'), btnHistory = $('btnHistory'),
      btnLogout = $('btnLogout');
const questionText = $('questionText'), metaInfo = $('metaInfo'), optionsDiv = $('options'), statusText = $('statusText');
const btnChangeTopic = $('btnChangeTopic'), historyList = $('historyList'), btnBackToTopics = $('btnBackToTopics'), btnClearHistory = $('btnClearHistory');
const resultTitle = $('resultTitle'), resultMsg = $('resultMsg'), btnBackHome = $('btnBackHome'), btnLogout2 = $('btnLogout2');
const splash = $('splash'), splashPhrase = $('splashPhrase');
const btnEN = $('btnEN'), btnES = $('btnES');
const welcomeTitle = $('welcomeTitle'), welcomeMeta = $('welcomeMeta');
const chooseTitle = $('chooseTitle'), chooseMeta = $('chooseMeta');
const leadText = $('leadText'), footerText = $('footerText');
const btnStart = $('btnStart'), btnGuest = $('btnGuest');
const btnOpenQuizEl = $('btnOpenQuiz'), btnHistoryEl = $('btnHistory');

/* =========================
   Internationalization
   ========================= */
function t(k){
  const lang = state.current.lang || 'en';
  return (I18N[lang] && I18N[lang][k]) || I18N['en'][k] || '';
}

function applyTranslations(){
  // top-level texts
  welcomeTitle.textContent = t('welcome');
  welcomeMeta.textContent = t('welcomeMeta');
  btnStart.textContent = t('start');
  btnGuest.textContent = t('guest');
  chooseTitle.textContent = t('chooseTopic');
  chooseMeta.textContent = t('chooseMeta');
  btnOpenQuizEl.textContent = t('viewQuestion');
  btnHistoryEl.textContent = t('history');
  $('btnBackHome').textContent = t('back');
  $('btnLogout').textContent = t('logout');
  $('btnLogout2').textContent = t('logout');
  $('btnChangeTopic').textContent = t('change');
  $('btnBackToTopics').textContent = t('back');
  $('btnClearHistory').textContent = t('clearHistory');
  $('historyTitle').textContent = t('history');
  $('historyMeta').textContent = t('history');
  leadText.textContent = t('welcomeMeta');
  $('screen-login').querySelector('input')?.setAttribute('placeholder', state.current.lang === 'es' ? 'Tu nombre (ej. Judson)' : 'Your name (e.g. Judson)');
  $('splashPhrase').textContent = pickSplashPhrase(); // always english phrases per requirement
  // footer-language agnostic
}

/* =========================
   Splash / Stoic phrases
   ========================= */
function pickSplashPhrase(){
  // phrases must be English as requested
  const i = Math.floor(Math.random()*STOIC_PHRASES_EN.length);
  return STOIC_PHRASES_EN[i];
}
function showSplashThenInit(){
  splash.style.display = 'flex';
  splashPhrase.textContent = pickSplashPhrase();
  // hide after 2000ms
  setTimeout(()=>{ splash.style.display = 'none'; initApp(); }, 2000);
}

/* =========================
   UI helpers
   ========================= */
function showScreen(el){
  screens.forEach(s=>{ s.classList.remove('active'); s.setAttribute('aria-hidden','true'); });
  el.classList.add('active'); el.setAttribute('aria-hidden','false');
  // small logo pulse
  const logo = document.querySelector('.logo'); if(logo){ logo.style.transform='scale(.98)'; setTimeout(()=>logo.style.transform='scale(1)',220); }
}

function renderTopics(){
  topicsDiv.innerHTML = '';
  const TOPICS = Object.keys(BANK);
  TOPICS.forEach(t=>{
    const d = document.createElement('div');
    d.className = 'topic';
    d.textContent = (state.current.lang==='es') ? translateTopicToES(t) : t;
    if(state.current.topic === t) d.classList.add('selected');
    d.onclick = ()=>{ state.current.topic = t; saveState(state); renderTopics(); };
    topicsDiv.appendChild(d);
  });
}

function translateTopicToES(t){
  // basic mapping for provided topics
  const map = {'Science':'Ciencia','History':'Historia','Mathematics':'Matemáticas','General Culture':'Cultura General'};
  return map[t] || t;
}

/* =========================
   Auth / Session
   ========================= */
function loginAs(name){
  state.current.name = name;
  if(!state.users[name]) state.users[name] = { history: [], lastAnswered: '' };
  // if lastAnswered exists and it's older than today, clear lastAnswered to allow respond
  const last = state.users[name].lastAnswered || '';
  if(last && last !== todayKey()){
    state.users[name].lastAnswered = '';
  }
  saveState(state);
  renderApp();
  showScreen(screenTopics);
}

function logout(){
  if(confirm(t('logoutConfirm'))){
    state.current = { name:null, topic:null, lang: state.current.lang || 'en' };
    saveState(state);
    applyTranslations();
    renderApp();
    showScreen(screenLogin);
  }
}

/* =========================
   Quiz logic (1 per day)
   ========================= */
function hasAnsweredToday(name){
  if(!name) return false;
  const u = state.users[name];
  return !!(u && u.lastAnswered === todayKey());
}

function deterministicIndex(name, topic){
  const pool = BANK[topic] || [];
  if(pool.length===0) return 0;
  // create simple hash from name + date to vary daily per user deterministically
  const d = new Date();
  const day = d.getDate() + d.getMonth() + d.getFullYear();
  let h = 0;
  const s = (name || 'guest') + topic;
  for(let i=0;i<s.length;i++){ h = ((h<<5)-h) + s.charCodeAt(i); h |= 0; }
  const idx = Math.abs((Math.abs(h) + day) % pool.length);
  return idx;
}

function renderQuiz(){
  if(!state.current.name) return alert(state.current.lang==='es'? 'Inicia sesión primero' : 'Please login first');
  if(!state.current.topic) return alert(state.current.lang==='es'? 'Selecciona un tema' : 'Please choose a topic');
  const topic = state.current.topic;
  const pool = BANK[topic];
  const qIdx = deterministicIndex(state.current.name, topic);
  const q = pool[qIdx];

  questionText.textContent = (state.current.lang==='es') ? translateQToES(q.q) : q.q;
  metaInfo.textContent = `${(state.current.lang==='es') ? translateTopicToES(topic) : topic} • ${(state.current.lang==='es') ? 'Pregunta del día' : 'Question of the day'}`;

  optionsDiv.innerHTML = '';
  q.opts.forEach((opt,i)=>{
    const o = document.createElement('div');
    o.className = 'option';
    o.setAttribute('role','button');
    o.tabIndex = 0;
    o.textContent = (state.current.lang==='es') ? translateQToES(opt) : opt;
    o.onclick = ()=> selectAnswer(qIdx, i, q);
    o.onkeypress = (e)=>{ if(e.key === 'Enter') selectAnswer(qIdx, i, q); };
    optionsDiv.appendChild(o);
  });

  // If user already answered today, disable options and show message
  if(hasAnsweredToday(state.current.name)){
    const u = state.users[state.current.name];
    statusText.textContent = t('alreadyAnsweredMsg');
    // find last record to show correct/wrong markings
    const last = (u.history || []).slice(-1)[0];
    if(last && last.date === todayKey()){
      const optionEls = document.querySelectorAll('.option');
      optionEls.forEach((el, idx) => {
        el.classList.add('disabled');
        if(idx === last.answer) el.classList.add('correct');
        if(idx === last.chosen && !last.correct) el.classList.add('wrong');
      });
    } else {
      document.querySelectorAll('.option').forEach(el => el.classList.add('disabled'));
    }
  } else {
    statusText.textContent = '';
  }

  showScreen(screenQuiz);
}

function selectAnswer(questionIdxInPool, chosenIndex, q){
  if(hasAnsweredToday(state.current.name)){
    alert(t('alreadyAnsweredTitle'));
    return;
  }
  const pool = BANK[state.current.topic];
  const realQ = pool[questionIdxInPool];
  const correct = chosenIndex === realQ.a;

  const optionEls = document.querySelectorAll('.option');
  optionEls.forEach(el => el.classList.add('disabled'));
  optionEls[chosenIndex].classList.add(correct? 'correct' : 'wrong');
  optionEls[realQ.a].classList.add('correct');

  // save record
  const record = {
    date: todayKey(),
    ts: new Date().toISOString(),
    topic: state.current.topic,
    question: realQ.q,
    chosen: chosenIndex,
    answer: realQ.a,
    correct
  };
  state.users[state.current.name].history.push(record);
  state.users[state.current.name].lastAnswered = todayKey();
  saveState(state);

  // show result after small delay
  setTimeout(()=> showResultScreen(correct, state.current.topic, realQ.q), 700);
}

/* =========================
   Result & History UI
   ========================= */
function showResultScreen(correct, topic, questionTextStr){
  const name = state.current.name || (state.current.lang==='es' ? 'Amigo' : 'Friend');
  if(correct){
    resultTitle.textContent = `${t('correctTitle')} ${state.current.lang==='es' ? '' : ''}`;
    resultMsg.textContent = t('correctMsg');
  } else {
    resultTitle.textContent = t('wrongTitle');
    resultMsg.textContent = t('wrongMsg');
  }
  showScreen(screenResult);
}

function renderHistory(){
  historyList.innerHTML = '';
  if(!state.current.name || !state.users[state.current.name] || state.users[state.current.name].history.length === 0){
    const p = document.createElement('div');
    p.className = 'meta';
    p.textContent = t('historyEmpty');
    historyList.appendChild(p);
    return;
  }
  const hist = state.users[state.current.name].history.slice().reverse();
  hist.forEach(h=>{
    const d = document.createElement('div');
    d.className = 'hist-item';
    const left = document.createElement('div'); left.style.maxWidth='65%';
    const title = document.createElement('div'); title.style.fontWeight='700'; title.textContent = (state.current.lang==='es') ? translateTopicToES(h.topic) : h.topic;
    const qtiny = document.createElement('div'); qtiny.style.fontSize='12px'; qtiny.style.color='var(--muted)'; qtiny.style.marginTop='6px';
    qtiny.textContent = (state.current.lang==='es') ? translateQToES(h.question) : h.question;
    left.appendChild(title); left.appendChild(qtiny);

    const right = document.createElement('div'); right.style.textAlign='right';
    const ok = document.createElement('div'); ok.textContent = h.correct ? (state.current.lang==='es' ? 'Correcto' : 'Correct') : (state.current.lang==='es' ? 'Incorrecto' : 'Incorrect');
    const when = document.createElement('div'); when.style.fontSize='11px'; when.style.color='var(--muted)'; when.style.marginTop='6px';
    when.textContent = new Date(h.ts).toLocaleString(state.current.lang==='es' ? 'es-CR' : 'en-US');
    right.appendChild(ok); right.appendChild(when);

    d.appendChild(left); d.appendChild(right);
    historyList.appendChild(d);
  });
}

/* =========================
   Utilities: translations for questions/answers (minimal)
   ========================= */
function translateQToES(text){
  // basic translations for items in our BANK (en -> es)
  const map = {
    "What is the basic unit of life?":"¿Cuál es la unidad básica de la vida?",
    "Atom":"Átomo","Cell":"Célula","Molecule":"Molécula","Organ":"Órgano",
    "Which gas do we mainly breathe?":"¿Qué gas respiramos principalmente?",
    "Nitrogen":"Nitrógeno","Oxygen":"Oxígeno","Hydrogen":"Hidrógeno","Carbon dioxide":"Dióxido de carbono",
    "In which year did Columbus reach America?":"¿En qué año llegó Colón a América?",
    "Who was the first President of the United States?":"¿Quién fue el primer presidente de Estados Unidos?",
    "What is 12 × 8?":"¿Cuánto es 12 × 8?",
    "Approximate value of π?":"¿Valor aproximado de π?",
    "What is the capital of Costa Rica?":"¿Cuál es la capital de Costa Rica?",
    "Who wrote \"One Hundred Years of Solitude\"?":"¿Quién escribió \"Cien años de soledad\"?",
    "San José":"San José","Alajuela":"Alajuela","Heredia":"Heredia","Cartago":"Cartago"
  };
  return map[text] || text;
}

/* =========================
   Event Listeners & Init
   ========================= */
btnStart.addEventListener('click', ()=>{ const n = inputName.value.trim(); if(!n) return alert(state.current.lang==='es'? 'Escribe tu nombre' : 'Please enter your name'); loginAs(n); });
btnGuest.addEventListener('click', ()=> loginAs(state.current.lang==='es' ? 'Invitado' : 'Guest'));
btnLogout.addEventListener('click', logout);
btnLogout2.addEventListener('click', logout);

$('btnOpenQuiz').addEventListener('click', ()=> {
  if(!state.current.topic) return alert(state.current.lang==='es' ? 'Selecciona un tema primero' : 'Please select a topic first');
  // if already answered today -> show result or message
  const u = state.users[state.current.name] || { lastAnswered: '' };
  if(u.lastAnswered && u.lastAnswered === todayKey()){
    // show result using last record
    const last = (u.history || []).slice(-1)[0];
    if(last) showResultScreen(last.correct, last.topic, last.question);
    else showScreen(screenTopics);
  } else {
    renderQuiz();
  }
});

$('btnHistory').addEventListener('click', ()=> { renderHistory(); showScreen(screenHistory); });
$('btnBackToTopics').addEventListener('click', ()=> showScreen(screenTopics));
$('btnClearHistory').addEventListener('click', ()=> {
  if(!state.current.name) return;
  if(confirm(t('deleteConfirm'))){
    state.users[state.current.name].history = [];
    saveState(state);
    renderHistory();
  }
});
$('btnChangeTopic').addEventListener('click', ()=> showScreen(screenTopics));
btnBackHome.addEventListener('click', ()=> {
  renderApp();
  showScreen(screenTopics);
});

/* Language toggle buttons */
btnEN.addEventListener('click', ()=> { setLang('en'); });
btnES.addEventListener('click', ()=> { setLang('es'); });

function setLang(lang){
  state.current.lang = lang;
  saveState(state);
  // toggle button active classes & aria-pressed
  if(lang==='en'){ btnEN.classList.add('active'); btnEN.setAttribute('aria-pressed','true'); btnES.classList.remove('active'); btnES.setAttribute('aria-pressed','false'); }
  else { btnES.classList.add('active'); btnES.setAttribute('aria-pressed','true'); btnEN.classList.remove('active'); btnEN.setAttribute('aria-pressed','false'); }
  applyTranslations();
  // re-render screens text as necessary
  renderTopics();
  // update placeholders & others
  if(state.current.name) renderApp();
}

/* Render app initial */
function renderApp(){
  userShort.textContent = state.current.name || '';
  applyTranslations();
  renderTopics();

  if(state.current.name){
    const u = state.users[state.current.name] || { lastAnswered: '' };
    if(u.lastAnswered && u.lastAnswered === todayKey()){
      // show the result immediately (with last record) to indicate already answered
      const last = (u.history || []).slice(-1)[0];
      if(last){
        showResultScreen(last.correct, last.topic, last.question);
      } else {
        showScreen(screenTopics);
      }
    } else {
      showScreen(screenTopics);
    }
  } else {
    showScreen(screenLogin);
  }
}

/* On load: hide splash after brief period and init */
(function startup(){
  // ensure language defaults: keep persisted or browser default
  if(!state.current.lang) state.current.lang = 'en';
  if(state.current.lang === 'en'){ btnEN.classList.add('active'); btnES.classList.remove('active'); }
  else { btnES.classList.add('active'); btnEN.classList.remove('active'); }
  applyTranslations();

  // show splash with English stoic phrases (per requirement)
  showSplashThenInit();
})();

/* For accessibility: allow Enter key on name input */
inputName.addEventListener('keypress', (e)=>{ if(e.key === 'Enter'){ btnStart.click(); } });

/* Optional: simple keyboard nav for options (arrow keys) */
document.addEventListener('keydown', (e)=>{
  if(document.querySelector('.screen.active') === screenQuiz){
    const opts = Array.from(document.querySelectorAll('.option:not(.disabled)'));
    if(opts.length === 0) return;
    const focused = document.activeElement;
    let idx = opts.indexOf(focused);
    if(e.key === 'ArrowDown'){ idx = (idx + 1) % opts.length; opts[idx].focus(); }
    if(e.key === 'ArrowUp'){ idx = (idx - 1 + opts.length) % opts.length; opts[idx].focus(); }
  }
});

</script>
</body>
</html>
